name: Release
on:
    push:
      tags:
        - '*-?[0-9]+*'


jobs:
  linux-release:
    name: cargo publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo publish --token ${CRATES_TOKEN}
        env:
            CRATES_TOKEN: ${{ secrets.CRATES_TOKEN }}
      - run: cargo build --release
      - run: cp target/release/libsqlite_uuid.so libsqlite-uuid-ubuntu
      - name: Upload artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: libsqlite-uuid-ubuntu
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  mac-release:
    name: cargo publish mac
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo build --release
      - run: cp target/release/libsqlite_uuid.dylib libsqlite-uuid-macos
      - name: Upload artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: libsqlite-uuid-macos
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  mac-arm-release:
    name: cargo publish mac arm
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin
      - run: cargo build --release --target aarch64-apple-darwin
      - run: cp target/aarch64-apple-darwin/release/libsqlite_uuid.dylib libsqlite-uuid-macos-arm
      - name: Upload artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: libsqlite-uuid-macos-arm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
